---
name: PR

on:
  pull_request:
    branches: ["main"]
  workflow_dispatch:

env:
  image_path: /tmp/image.tar

jobs:
  vars:
    name: Variables
    runs-on: ubuntu-latest
    outputs:
      sha_short: ${{ steps.vars.outputs.sha_short }}
      image_name: ${{ steps.vars.outputs.image_name }}
    steps:
      - uses: actions/checkout@v3
      - id: vars 
        run: |
          echo "sha_short=$(git rev-parse --short HEAD)" >> "$GITHUB_OUTPUT"
          echo "image_name=${{ env.RECIPES_CR }}${{ github.repository }}" >> "$GITHUB_OUTPUT"
      - run: echo "$image_name:$sha_short"
        env:
          sha_short: ${{ steps.vars.outputs.sha_short }}
          image_name: ${{ steps.vars.outputs.image_name }}

  code-checks:
    name: Code Checks
    runs-on: ubuntu-latest
    needs: vars
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: "3.11"
      - run: curl -sSL https://install.python-poetry.org | python3 - --version $RECIPES_POETRY_VERSION
      - run: poetry install
      - run: make fmt-check
      - run: make docs-build
      - run: make type-check
      - run: make test-coverage

  build-image:
    name: Build image
    runs-on: ubuntu-latest
    needs: vars
    env:
      sha_short: ${{ needs.vars.outputs.sha_short }}
      image_name: ${{ needs.vars.outputs.image_name }}
    steps:
      - uses: actions/checkout@v3
      - run: docker build -t $image_name:$sha_short .
      - run: docker save $image_name -o $image_path
      - uses: actions/upload-artifact@v3
        with:
          name: image
          path: ${{ env.image_path }}

  push-image:
    name: Push image
    runs-on: ubuntu-latest
    needs: [vars, code-checks, build-image]
    env:
      sha_short: ${{ needs.vars.outputs.sha_short }}
      image_name: ${{ needs.vars.outputs.image_name }}
    steps:
      - uses: actions/download-artifact@v3
        with:
          name: image
          path: /tmp
      - uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DO_CI }}
      - run: doctl registry login
      - run: docker load --input $image_path
      - run: echo $image_name:$sha_short
      - run: echo docker image ls -a
      - run: docker push $image_name:$sha_short
