---
name: PR

on:
  pull_request:
    branches: ["main"]
  workflow_dispatch:

env:
  FORCE_COLOR: "1"
  POETRY_VERSION: "1.6.1"

jobs:
  set-vars:
    name: Set environment variables
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - run: |
          echo "SHA_SHORT=$(git rev-parse --short HEAD)" >> "$GITHUB_ENV"
          echo "IMAGE_NAME=${{ github.repository }}:$SHA_SHORT" >> "$GITHUB_ENV"
          echo "FULLY_QUALIFIED_IMAGE_NAME=$RECIPES_CR$IMAGE_NAME" >> "$GITHUB_ENV"
          printenv


  code-checks:
    name: Code Checks
    runs-on: ubuntu-latest
    needs: set-vars
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: "3.11"
      - run: curl -sSL https://install.python-poetry.org | python3 - --version $POETRY_VERSION
      - run: poetry install
      - run: make fmt-check
      - run: make docs-build
      - run: make type-check
      - run: make test-coverage

  build-image:
    name: Build image
    runs-on: ubuntu-latest
    needs: set-vars
    steps:
      - uses: actions/checkout@v3
      - uses: docker/setup-buildx-action@v2
      - uses: docker/build-push-action@v4
        with:
          context: .
          tags: ${{ env.IMAGE_NAME }}
          outputs: type=docker,dest=/tmp/${{ env.IMAGE_NAME }}.tar
      - uses: actions/upload-artifact@v3
        with:
          name: ${{ env.IMAGE_NAME }}
          path: /tmp/${{ env.IMAGE_NAME }}.tar

  push-image:
    name: Push image
    runs-on: ubuntu-latest
    needs: [code-checks, build-image]
    steps:
      - uses: actions/download-artifact@v3
        with:
          name: ${{ env.IMAGE_NAME }}
          path: /tmp
      - uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DO_CI }}
      - run: doctl registry login
      - run: docker load --input /tmp/$IMAGE_NAME.tar
      - run: docker tag $IMAGE_NAME $FULLY_QUALIFIED_IMAGE_NAME
      - run: docker push $FULLY_QUALIFIED_IMAGE_NAME
